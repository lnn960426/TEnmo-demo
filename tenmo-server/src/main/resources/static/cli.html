<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>TEnmo Console (Web)</title>
    <style>
        :root { color-scheme: dark; }
        html,body { height:100%; }
        body { margin:0; background:#0b0f14; color:#e5e7eb; font:14px/1.6 ui-monospace,Menlo,Consolas,monospace; }
        .wrap { max-width: 900px; margin: 24px auto; padding: 16px; }
        #term { white-space: pre-wrap; background:#0e131a; border:1px solid #1f2937; border-radius:12px; padding:18px; min-height:60vh; }
        #prompt { display:flex; gap:8px; align-items:center; margin-top:12px; }
        #ps { color:#60a5fa; }
        #cmd { flex:1; background:#0e131a; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:10px 12px; outline:none; }
        #cmd::placeholder { color:#64748b; }
        .hint { color:#94a3b8; margin-top:8px; }
        a { color:#93c5fd; text-decoration:none; } a:hover{ text-decoration:underline; }
    </style>
</head>
<body>
<div class="wrap">
    <div id="term"></div>
    <div id="prompt">
        <span id="ps">$</span>
        <input id="cmd" placeholder="type here and press Enter…" autofocus />
    </div>
    <div class="hint">Health: <a href="/demo/health" target="_blank">/demo/health</a> · GUI page: <a href="/demo.html" target="_blank">/demo.html</a></div>
</div>

<script>
    /* Menu-driven Web Console that mirrors your Java CLI app flow. */

    const term = document.getElementById('term');
    const input = document.getElementById('cmd');
    const PS = document.getElementById('ps');

    const S = {
      token: localStorage.getItem('TENMO_TOKEN') || null,
      user: localStorage.getItem('TENMO_USER') || null,
      userId: null, // we fetch when needed
      step: null,   // which prompt handler is active
      tmp: {}       // temp values across steps
    };

    function println(s=''){ term.textContent += s + '\n'; term.scrollTop = term.scrollHeight; }
    function clear(){ term.textContent=''; }
    function setSession(token, username){
      S.token = token || null;
      S.user = username || null;
      if(token){ localStorage.setItem('TENMO_TOKEN', token); localStorage.setItem('TENMO_USER', username||''); }
      else { localStorage.removeItem('TENMO_TOKEN'); localStorage.removeItem('TENMO_USER'); }
      PS.textContent = S.user ? `${S.user}@tenmo$` : '$';
    }
    PS.textContent = S.user ? `${S.user}@tenmo$` : '$';

    async function api(path, method='GET', body){
      const headers = { 'Content-Type':'application/json' };
      if(S.token) headers.Authorization = `Bearer ${S.token}`;
      const res = await fetch(path, { method, headers, body: body?JSON.stringify(body):undefined });
      const txt = await res.text();
      let data = null; try{ data = txt?JSON.parse(txt):null; }catch{ data = txt; }
      return { ok: res.ok, status: res.status, body: data };
    }

    /* ---------- Menus & Flows (mirror your ConsoleService) ---------- */

    function printGreeting(){
      println("******************************");
      println("* Welcome to TEnmo!          *");
      println("******************************");
    }

    function printLoginMenu(){
      println("\n1: Register");
      println("2: Login");
      println("0: Exit");
    }

    function printMainMenu(){
      println("\n-----------------------------------");
      println("Main Menu");
      println("-----------------------------------");
      println("1: View your current balance");
      println("2: View your past transfers");
      println("3: View your pending requests");
      println("4: Send TE bucks");
      println("5: Request TE bucks");
      println("0: Exit");
    }

    function startApp(){
      clear(); printGreeting();
      if(!S.token){ loginMenu(); }
      else { println(`(session restored for ${S.user})`); mainMenu(); }
    }

    function loginMenu(){
      printLoginMenu();
      prompt("Please choose an option: ", handleLoginMenu);
    }

    function handleLoginMenu(val){
      const n = Number(val);
      if(n === 1) { doRegister(); }
      else if(n === 2) { doLogin(); }
      else if(n === 0) { println("Bye."); }
      else { println("Invalid Selection"); loginMenu(); }
    }

    function doRegister(){
      println("Please register a new user account");
      S.tmp = {};
      promptUsername(async (u)=>{
        S.tmp.username = u;
        prompt("Enter password: ", async (p)=>{
          const {ok,status,body} = await api('/demo/register','POST',{username:u,password:p});
          if(ok){ println("Registration successful. You can now login."); }
          else { println(`Registration failed (${status}): ${JSON.stringify(body)}`); }
          loginMenu();
        });
      });
    }

    function doLogin(){
      S.tmp = {};
      promptUsername(async (u)=>{
        S.tmp.username = u;
        prompt("Enter password: ", async (p)=>{
          const {ok,status,body} = await api('/demo/login','POST',{username:u,password:p});
          if(!ok){ println("Login failed."); loginMenu(); return; }
          const token = body?.token || body?.id_token || body?.jwt;
          if(!token){ println("Server did not return token."); loginMenu(); return; }
          setSession(token, u);
          println("Login successful.");
          mainMenu();
        });
      });
    }

    function mainMenu(){
      printMainMenu();
      prompt("Please choose an option: ", handleMainMenu);
    }

    function handleMainMenu(val){
      const n = Number(val);
      if(n===1) viewCurrentBalance();
      else if(n===2) viewTransferHistory();
      else if(n===3) viewPendingRequests();
      else if(n===4) sendBucks();
      else if(n===5) requestBucks();
      else if(n===0){ println("Bye."); }
      else { println("Invalid Selection"); mainMenu(); }
    }

    /* ---- 1) Balance ---- */
    async function viewCurrentBalance(){
      const {ok,status,body} = await api('/demo/balance');
      if(ok){ println(`Your current balance is: $${body.balance}`); }
      else { println(`Error (${status}): ${JSON.stringify(body)}`); }
      pauseThen(mainMenu);
    }

    /* ---- 2) Transfers history ---- */
    async function viewTransferHistory(){
      const {ok,status,body} = await api('/demo/transfers');
      if(!ok){ println(`Error (${status}): ${JSON.stringify(body)}`); return pauseThen(mainMenu); }

      println("-----------------------------------");
      println("Transfers");
      println("ID            From/To        Amount");
      println("-----------------------------------");
      (body||[]).forEach(t=>{
        const line = `${String(t.transferId).padEnd(12)} ${("From: "+t.fromUsername).padEnd(15)} ${("To: "+t.toUsername).padEnd(15)}  $ ${t.transferAmount}`;
        println(line);
      });
      println("-----------------------------------");
      promptInt("Please enter transfer ID to view detail (0 to cancel): ", async (id)=>{
        if(id===0){ println("Cancelled."); return pauseThen(mainMenu); }
        const {ok:ok2,status:s2,body:b2} = await api(`/demo/transfers/${id}`);
        if(!ok2){ println(`Transfer not found. (${s2})`); return pauseThen(mainMenu); }
        println("_________________________________________");
        println("Transfer Details");
        println("_________________________________________");
        println(`ID: ${b2.transferId}`);
        println(`From: ${b2.fromUsername}`);
        println(`To: ${b2.toUsername}`);
        println(`TransferType: ${b2.transferTypeId}`);
        println(`TransferStatus: ${b2.transferStatusId}`);
        println(`Amount: $${b2.transferAmount}`);
        println("_________________________________________");
        pauseThen(mainMenu);
      });
    }

    /* ---- 3) Pending requests ---- */
    async function viewPendingRequests(){
      const {ok,status,body} = await api('/demo/transfers/pending');
      println("PendingID       TransferTo          Amount");
      println("------------------------------------------");
      if(ok && Array.isArray(body)){
        body.forEach(t=>{
          println(`${String(t.transferId).padEnd(15)} ${String(t.toUsername).padEnd(18)} $${t.transferAmount}`);
        });
      } else {
        println(`Error (${status}): ${JSON.stringify(body)}`);
      }
      println("------------------------------------------");
      promptInt("Please enter transfer ID to approve/reject,(0) to cancel: ", (choice)=>{
        if(choice===0){ println("Cancelled."); return pauseThen(mainMenu); }
        println("1:Approve"); println("2:Reject");
        promptInt("Choose action: ", async (act)=>{
          if(act===1){
            const {ok:ok2,status:s2} = await api(`/demo/transfers/${choice}/approve`,'POST');
            println(ok2?"Transfer approved.":"Approve failed ("+s2+")");
            return viewCurrentBalanceThenMenu();
          } else if(act===2){
            const {ok:ok3,status:s3} = await api(`/demo/transfers/${choice}/reject`,'POST');
            println(ok3?"Transfer rejected.":"Reject failed ("+s3+")");
            return viewCurrentBalanceThenMenu();
          } else {
            println("Invalid choice");
            pauseThen(mainMenu);
          }
        });
      });
    }

    async function viewCurrentBalanceThenMenu(){
      const {ok,body} = await api('/demo/balance');
      if(ok) println(`Your current balance is: $${body.balance}`);
      pauseThen(mainMenu);
    }

    /* ---- 4) Send bucks ---- */
    async function sendBucks(){
      // list users (excluding self)
      const {ok,status,body} = await api('/demo/users');
      println("-----------------------------------");
      println("Users");
      println("ID                             Name");
      println("-----------------------------------");
      if(ok){
        (body||[]).forEach(u=>{
          println(`${String(u.id).padEnd(30)} ${u.username}`);
        });
      } else {
        println(`Error (${status}) while loading users`);
      }
      println("-----------------------------------");
      promptInt("Enter ID of user you want to sending TEBucks (0 to cancel): ", (toId)=>{
        if(toId===0){ println("Cancelled."); return pauseThen(mainMenu); }
        prompt("Please Enter the amount you want to send: ", async (amtText)=>{
          const {ok:ok2,status:s2,body:b2} = await api('/demo/send','POST',{ toUserId: toId, amount: amtText });
          println(ok2 ? "Send success." : `Send failed (${s2}): ${JSON.stringify(b2)}`);
          viewCurrentBalanceThenMenu();
        });
      });
    }

    /* ---- 5) Request bucks ---- */
    async function requestBucks(){
      const {ok,status,body} = await api('/demo/users');
      println("-----------------------------------");
      println("Users");
      println("ID                             Name");
      println("-----------------------------------");
      if(ok){
        (body||[]).forEach(u=>{
          println(`${String(u.id).padEnd(30)} ${u.username}`);
        });
      } else {
        println(`Error (${status}) while loading users`);
      }
      println("-----------------------------------");
      promptInt("Enter ID of user you want to requesting TEBucks (0 to cancel): ", (toId)=>{
        if(toId===0){ println("Cancelled."); return pauseThen(mainMenu); }
        prompt("Please Enter the amount you want to request: ", async (amtText)=>{
          const {ok:ok2,status:s2,body:b2} = await api('/demo/request','POST',{ toUserId: toId, amount: amtText });
          println(ok2 ? "Request submitted." : `Request failed (${s2}): ${JSON.stringify(b2)}`);
          viewCurrentBalanceThenMenu();
        });
      });
    }

    /* ---------- tiny prompt helpers ---------- */
    function prompt(msg, handler){
      println(msg);
      S.step = (val)=>{
        handler(String(val||'').trim());
      };
    }
    function promptInt(msg, handler){
      prompt(msg, (v)=>{
        const n = Number(v);
        if(Number.isNaN(n)) { println("Invalid number"); promptInt(msg, handler); }
        else handler(n);
      });
    }
    function pauseThen(next){
      println(""); println("Press Enter to continue...");
      S.step = ()=> next();
    }

    /* input dispatch */
    input.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        const v = input.value; input.value='';
        if(typeof S.step === 'function'){ const fn = S.step; S.step=null; fn(v); }
      }
    });

    /* username helper */
    function promptUsername(cb){
      prompt("Enter username: ", (u)=>{
        if(!u){ println("Username required."); return promptUsername(cb); }
        cb(u);
      });
    }

    /* boot */
    startApp();
</script>
</body>
</html>
